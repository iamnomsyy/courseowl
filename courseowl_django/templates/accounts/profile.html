{% extends "base.html" %}
{% block content %}
{% load socialaccount %}

<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
<div class="pagination-centered">
<div class="col-md-6 col-sm-6">
            <div class="container">
                 <div class="row vertical-center-row row-md-offset-4">
                  <div class="form">
                     <h2>Welcome </h2>
                     <p><h4><i class="glyphicon glyphicon-user"></i> {{ email }}</h4></p>
<!-- testing for table / topbar / color, akshay-->
    <div class="topbar">
      <div class="fill">
        <div class="container span18">
        </div>
      </div>
    </div>

    <div class="container span18">
      <div class='cleaner_h40'></div>
        <div class='span14'>
          {% if enrolled_list %}
          <h2>Active Courses</h2>
          <table class='table table-striped'>
              <thead>
                  <tr>

                      <th class='span4'>Course</th>
                      <th class='span2'>Provider</th>
                      <th class='span2'>Instructor</th>
                      <th class='span4'>Action</th>
                  </tr>
              </thead>
              <tbody class="enrolled-courses">
              {%for course in enrolled_list %}
                  <tr data-id="{{course.id}}">
                      <td>{{ course.name }}</td>
                      <td>{{ course.provider }}</td>
                      <td>{{ course.instructor }}</td>
                      <td>
                        <button class='btn btn-small btn-info info-button' data-toggle="modal" data-target="#courseinfo">Course info</button>
                        <div class='btn btn-small btn-danger drop-button' data-toggle="drop-modal">
                          Drop course
                        </div>
                      </td>
                  </tr>
              {% endfor %}

              </tbody>
          </table>
        {% else %}
          <h2>It seems you have no active courses</h2>
          <a href="/course_preferences" class="btn btn-success btn-large">Add Courses</a>
        {% endif %}
          <h2>Recommendations</h2>
         <table class='table table-striped'>
              <thead>
                  <tr>

                      <th class='span4'>Course</th>
                      <th class='span2'>Provider</th>
                      <th class='span4'>Instructor</th>
                      <th class='span4'>Action</th>
                  </tr>
              </thead>
              <tbody class="recommended-courses">
              <!-- Check again -->
                {%for course in recommend_list %}
                  <tr data-id="{{ course.id }}">
                      <td>{{course.name}}</td>
                      <td>{{course.provider}}</td>
                      <td>{{course.instructor}}</td>
                      <td>
                        <div class='btn btn-small btn-info info-button' data-toggle="modal" data-target="#courseinfo">Course info</div>
                        <div class='btn btn-small btn-success add-course'>Add Course</div>
                      </td>
                  </tr>
                {% endfor %}
              </tbody>
          </table>
        </div><!-- do not modify the tags see zebra-striped , akshay-->
      </div>
    </div></div></div>
      <h2>Settings</h2>
        <a href='/personalize' class='btn btn-success btn-large'>Add more subjects and courses</a>
        <br /><br />
        <a class="btn btn-default change-credentials-button" data-toggle="drop-modal" onclick="$('#change-credentials').modal('show');">Change your email or password</a>
        <br /><br />
        <a class="btn btn-danger deactivate-button" data-toggle="drop-modal" onclick="$('#deactivate-account').modal('show');">Deactivate account</a>
    </div></div>
    <div class="row vertical-center-row row-md-offset-4"></div>

{% include "accounts/drop_course_modal.html" %}
{% include "accounts/credentials_modal.html" %}


<div class="modal fade" id="courseinfo" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="modalLabel">Course Information</h4>
      </div>
      <div class="modal-body" >

       <p><strong>Course: </strong><label id = "course_name"></label></p>
       <p><strong>Provider: </strong> <label id = "provider"></label> </p>
       <p><strong>Instructor: </strong><label id = "course_ins"></label></p>
       <strong>Description:</strong><p id = "course_desc"></p>
       <p><strong>Cost: Free</strong></p>
       <p><strong>Visit course at :</strong> <a id = "address" target="_blank" href = ""><strong id = "course_new_url"></strong> </a></p>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Deactivate account confirmation modal -->
<div class="modal fade" id="deactivate-account" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="modalLabel">Deactivate Account</h4>
      </div>
      <div class="modal-body">
        Are you sure you want to deactivate your CourseOwl account?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <a id="confirmDeactivate" type="button" class="btn btn-danger" href="/accounts/deactivate_account">Yes</a>
      </div>
    </div>
  </div>
</div>

<script>
  function setAddCourseListener() {
    $('.add-course').on('click', function(event) {
      var courseID = $(this).closest('tr').data('id');
      // Enroll in backend
      $.post(
        '/api/enroll',
        { course_to_add: courseID }
      ).done(function(res) {
        // on successful adding, move table row to enrolled table
        $recommended = $('tr[data-id="' + courseID + '"]');
        $recommended.fadeOut(function() {
          $dropButton = $('<div>', {
            'class': 'btn btn-small btn-danger drop-button',
            'data-toggle': 'modal'
          }).text('Drop course');
          $recommended.find('.add-course').replaceWith($dropButton);
          $recommended.appendTo('.enrolled-courses');
          $recommended.fadeIn();
        });
      });
    });
  }



  $(function() {
    var dropCourseID;
    // Allows dropping courses
    $('.enrolled-courses').on('click', '.drop-button', function(event) {
      event.preventDefault();
      var courseID = $(this).closest('tr').data('id');
      dropCourseID = courseID;
      $('#dropCourse').modal('show');
    });

    $('#confirmDrop').on('click', function(event) {
      $('#dropCourse').modal('hide');
      $.post(
        "/api/drop",
        { course_to_drop: dropCourseID }
      ).done(function(res) {
        var $courseRow = $('[data-id="' + dropCourseID + '"]');
        $($courseRow).fadeOut(function() {
          $($courseRow).remove();
        });
      });
    });

    setAddCourseListener();

  });


   $(function display_info() {
      $('.info-button').on('click', function(event) {
          var courseID = $(this).closest('tr').data('id');

          $.post(
            '/api/course_info',
                 { course_id : courseID }
          ).done(function(res){


              $('#course_name').text(res.info.name);
              $('#provider').text(res.info.provider);
              $('#course_ins').text(res.info.instructor);
              $('#course_desc').text(res.info.description);
              $('#course_new_url').text(res.info.newurl);
              $('#address').attr('href',res.info.newurl);

              });
            display_info();


   });
   });



</script>
{% endblock %}
